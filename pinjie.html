<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账单图片拼接工具</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            font-size: 14px;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -3px rgba(37, 99, 235, 0.4);
        }
        .dropzone {
            border: 2px dashed #93c5fd;
            transition: all 0.3s ease;
            background-color: rgba(191, 219, 254, 0.05);
        }
        .dropzone.active {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        .info-label {
            font-size: 1rem;
            font-weight: 600;
            color: #1e40af;
        }
        .info-value {
            font-size: 1.1rem;
            font-weight: 500;
            color: #1e3a8a;
        }
        .tag-style {
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 10px 14px;
            box-shadow: 0 3px 10px rgba(59, 130, 246, 0.15);
            background: white;
        }
        .amount-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: #FF6B00;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .copy-btn {
            background: rgba(30, 64, 175, 0.1);
            color: #1e40af;
            border: 1px solid #1e40af;
            transition: all 0.2s ease;
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        .copy-btn:hover {
            background: rgba(30, 64, 175, 0.2);
        }
        .copy-success {
            position: absolute;
            right: 0;
            top: -25px;
            background: #10b981;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .copy-success.show {
            opacity: 1;
        }
        .file-info {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 6px;
        }
        .file-count {
            color: #3b82f6;
            font-weight: 600;
        }
        .file-name {
            display: inline-block;
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: bottom;
        }
        .bg-pattern-1 {
            background-color: #ffffff;
        }
        .bg-pattern-2 {
            background: linear-gradient(135deg, #4a6cf7 0%, #9b51e0 100%);
        }
        .bg-pattern-3 {
            background-color: #ffffff;
            background-image: radial-gradient(#4a6cf7 1px, transparent 1px),
                              radial-gradient(#ff7b25 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        
        .bg-pattern-4 {
            background-color: #ffffff;
            background-image: 
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .bg-selected {
            border: 2px solid #3b82f6 !important;
            position: relative;
            transition: all 0.3s ease;
        }
        .bg-selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.3s ease;
        }
        .download-header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .save-hint {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: #1e40af;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        @media (max-width: 1024px) {
            .desktop-layout {
                flex-direction: column;
            }
            .desktop-layout > div {
                width: 100%;
            }
        }
        @media (max-width: 640px) {
            body {
                font-size: 13px;
            }
            .amount-display {
                font-size: 1.5rem;
            }
            .btn-primary {
                padding: 12px;
                min-height: 44px;
            }
            input, textarea {
                min-height: 44px;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 下载头部 -->
    <div id="downloadHeader" class="download-header hidden">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="text-lg font-semibold">
                <i class="fas fa-image mr-2"></i>拼接结果
            </div>
            <button id="downloadBtn" class="btn-primary px-6 py-2 rounded-lg text-base">
                <i class="fas fa-download mr-1"></i>下载图片
            </button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-10">
        <!-- 标题区域 -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-blue-700 mb-5">账单图片拼接工具</h1>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto">轻松将多张账单图片拼接成长图，并添加结算信息</p>
        </div>

        <!-- 主体布局 - 电脑端横向三栏，移动端垂直 -->
        <div class="desktop-layout flex flex-col lg:flex-row gap-6">
            <!-- 上传区域 -->
            <div class="glass-card p-6 flex-1">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-upload text-blue-500 mr-3 text-xl"></i>
                    上传账单图片
                </h2>
                
                <div id="dropzone" class="dropzone rounded-lg p-8 text-center cursor-pointer mb-6">
                    <div class="flex flex-col items-center justify-center">
                        <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-4"></i>
                        <p class="text-lg text-gray-600 mb-2">拖拽图片到此处或点击选择文件</p>
                        <p class="text-sm text-gray-500">支持JPG、PNG格式，最多可上传15张图片</p>
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept="image/*" multiple>
                </div>
                
                <button id="uploadBtn" class="btn-primary w-full py-3 rounded-lg text-lg">
                    <i class="fas fa-upload mr-2"></i>选择图片
                </button>
                
                <div id="previewContainer" class="mt-6 grid grid-cols-3 gap-3 hidden">
                    <h3 class="col-span-3 text-xl font-medium text-gray-700 mb-3">已上传图片预览</h3>
                    <div id="fileInfo" class="col-span-3 file-info hidden">
                        已上传 <span id="uploadedCount" class="file-count">0</span>/<span class="file-count">15</span> 张图片
                    </div>
                </div>
            </div>

            <!-- 结算信息区域 -->
            <div class="glass-card p-6 flex-1">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-cog text-blue-500 mr-3 text-xl"></i>
                    结算信息设置
                </h2>
                
                <div class="space-y-6">
                    <div class="tag-style">
                        <label class="info-label block mb-2">结算总金额</label>
                        <input type="text" id="amountInput" placeholder="请输入结算金额" 
                               class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base">
                    </div>
                    
                    <div class="tag-style relative">
                        <label class="info-label block mb-2">收款账号名称</label>
                        <div class="relative">
                            <input type="text" id="accountNameInput" placeholder="请输入收款账号名称" 
                                   class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base pr-14">
                            <button id="copyAccountBtn" class="copy-btn absolute right-2 top-1/2 transform -translate-y-1/2 px-2 py-1 rounded text-sm">
                                <i class="fas fa-copy mr-1"></i>复制
                            </button>
                            <div id="copySuccess" class="copy-success">
                                <i class="fas fa-check mr-1"></i>已复制
                            </div>
                        </div>
                    </div>
                    
                    <div class="tag-style">
                        <label class="info-label block mb-2">收款二维码内容</label>
                        <input type="text" id="qrContentInput" placeholder="请输入二维码内容（如收款链接）" 
                               class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base mb-3">
                        <div id="qrCodePreview" class="flex justify-center p-3 rounded-lg hidden">
                            <!-- 二维码将在这里生成 -->
                        </div>
                    </div>

                    <!-- 自定义二维码上传区域 -->
                    <div class="tag-style">
                        <label class="info-label block mb-2">上传自定义二维码</label>
                        <div id="customQrDropzone" class="dropzone rounded-lg p-4 text-center cursor-pointer mb-3">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-qrcode text-2xl text-blue-400 mb-2"></i>
                                <p class="text-gray-600 mb-1">拖拽二维码图片到此处或点击选择文件</p>
                                <p class="text-xs text-gray-500">支持JPG、PNG格式</p>
                            </div>
                            <input type="file" id="customQrInput" class="hidden" accept="image/*">
                        </div>
                        <div id="customQrPreview" class="hidden">
                            <p class="text-xs text-gray-600 mb-1">已上传自定义二维码：</p>
                            <div class="flex items-center">
                                <img id="customQrImage" class="w-20 h-20 border border-gray-200 rounded-lg mr-2">
                                <button id="removeCustomQrBtn" class="text-red-500 hover:text-red-700 text-sm">
                                    <i class="fas fa-trash-alt mr-1"></i>移除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 拼接设置区域 -->
            <div class="glass-card p-6 flex-1">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-sliders-h text-blue-500 mr-3 text-xl"></i>
                    拼接设置
                </h2>
                
                <div class="space-y-6">
                    <!-- 背景选择区域 -->
                    <div class="tag-style">
                        <h3 class="info-label block mb-3">选择背景样式</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="cursor-pointer" onclick="selectBackground('default')">
                                <div id="bg-default" class="h-16 rounded-lg bg-white border-2 border-blue-500 flex items-center justify-center">
                                    <span class="text-xs">纯白背景</span>
                                </div>
                            </div>
                            <div class="cursor-pointer" onclick="selectBackground('pattern2')">
                                <div id="bg-pattern2" class="h-16 rounded-lg bg-pattern-2 border-2 border-transparent hover:border-blue-500 flex items-center justify-center">
                                    <span class="text-xs text-white">蓝紫渐变</span>
                                </div>
                            </div>
                            <div class="cursor-pointer" onclick="selectBackground('pattern3')">
                                <div id="bg-pattern3" class="h-16 rounded-lg bg-pattern-3 border-2 border-transparent hover:border-blue-500 flex items-center justify-center">
                                    <span class="text-xs">几何图形</span>
                                </div>
                            </div>
                            <div class="cursor-pointer" onclick="selectBackground('pattern4')">
                                <div id="bg-pattern4" class="h-16 rounded-lg bg-pattern-4 border-2 border-transparent hover:border-blue-500 flex items-center justify-center">
                                    <span class="text-xs">网格线</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 rounded-lg border border-blue-100 bg-blue-50/30">
                        <h3 class="font-semibold text-blue-800 text-lg mb-3">拼接方向</h3>
                        <div class="flex items-center space-x-6">
                            <div>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="direction" value="vertical" checked class="text-blue-600 h-4 w-4">
                                    <span class="ml-2 text-base">垂直拼接</span>
                                </label>
                            </div>
                            <div>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="direction" value="horizontal" class="text-blue-600 h-4 w-4">
                                    <span class="ml-2 text-base">水平拼接</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button id="generateBtn" class="btn-primary w-full py-3 rounded-lg text-lg">
                        <i class="fas fa-magic mr-2"></i>生成拼接图片
                    </button>
                </div>
            </div>
        </div>

        <!-- 结果展示区域 -->
        <div id="resultContainer" class="glass-card p-6 mt-8 hidden">
            <div class="save-hint mb-4">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                长按图片可保存到相册
            </div>
            
            <div id="resultCanvasContainer" class="flex justify-center">
                <canvas id="resultCanvas" class="max-w-full border border-gray-200 rounded-lg shadow-md"></canvas>
            </div>
        </div>
    </div>

    <footer class="bg-gray-50 py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>created by <a href="https://space.coze.cn" class="text-blue-500 hover:underline">coze space</a></p>
            <p class="mt-1">页面内容均由含光 + AI 生成，仅供学习交流</p>
        </div>
    </footer>

    <script>
        let selectedBackground = 'default';
        
        function selectBackground(type) {
            selectedBackground = type;
            
            // 移除所有背景样式的选中状态
            document.querySelectorAll('[id^="bg-"]').forEach(el => {
                el.classList.remove('bg-selected');
                el.classList.remove('border-blue-500');
                el.classList.add('border-transparent');
            });
            
            // 添加当前选中背景的样式
            const bgElement = document.getElementById(`bg-${type}`);
            bgElement.classList.add('bg-selected');
            bgElement.classList.add('border-blue-500');
            bgElement.classList.remove('border-transparent');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 初始化选中默认背景
            selectBackground('default');
            
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const dropzone = document.getElementById('dropzone');
            const previewContainer = document.getElementById('previewContainer');
            const fileInfo = document.getElementById('fileInfo');
            const uploadedCount = document.getElementById('uploadedCount');
            const qrCodePreview = document.getElementById('qrCodePreview');
            const qrContentInput = document.getElementById('qrContentInput');
            const generateBtn = document.getElementById('generateBtn');
            const resultContainer = document.getElementById('resultContainer');
            const resultCanvas = document.getElementById('resultCanvas');
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadHeader = document.getElementById('downloadHeader');
            const copyAccountBtn = document.getElementById('copyAccountBtn');
            const accountNameInput = document.getElementById('accountNameInput');
            const copySuccess = document.getElementById('copySuccess');
            const customQrInput = document.getElementById('customQrInput');
            const customQrDropzone = document.getElementById('customQrDropzone');
            const customQrPreview = document.getElementById('customQrPreview');
            const customQrImage = document.getElementById('customQrImage');
            const removeCustomQrBtn = document.getElementById('removeCustomQrBtn');
            
            let uploadedImages = [];
            let uploadedFiles = [];
            let customQrImg = null;
            
            // 上传按钮点击事件
            uploadBtn.addEventListener('click', () => fileInput.click());
            
            // 文件选择事件
            fileInput.addEventListener('change', handleFileSelect);
            
            // 拖放区域事件
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropzone.classList.add('active');
            }
            
            function unhighlight() {
                dropzone.classList.remove('active');
            }
            
            dropzone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
            
            function handleFileSelect(e) {
                const files = e.target.files;
                handleFiles(files);
            }
            
            function handleFiles(files) {
                if (files.length > 15) {
                    alert('最多只能上传15张图片');
                    return;
                }
                
                uploadedImages = [];
                uploadedFiles = Array.from(files);
                previewContainer.innerHTML = '<h3 class="col-span-3 text-xl font-medium text-gray-700 mb-3">已上传图片预览</h3>';
                
                Array.from(files).forEach((file, index) => {
                    if (!file.type.match('image.*')) {
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = function() {
                            uploadedImages.push(img);
                            addImagePreview(img, file.name);
                            
                            // 更新上传数量显示
                            uploadedCount.textContent = uploadedImages.length;
                            fileInfo.classList.remove('hidden');
                            
                            if (index === files.length - 1) {
                                previewContainer.classList.remove('hidden');
                            }
                        };
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            function addImagePreview(img, fileName) {
                const previewItem = document.createElement('div');
                previewItem.className = 'overflow-hidden rounded-lg border border-gray-200 relative';
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxSize = 120;
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // 添加文件名
                const fileNameEl = document.createElement('div');
                fileNameEl.className = 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 truncate';
                fileNameEl.textContent = fileName;
                
                previewItem.appendChild(canvas);
                previewItem.appendChild(fileNameEl);
                previewContainer.appendChild(previewItem);
            }
            
            // 二维码生成
            qrContentInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    qrCodePreview.classList.add('hidden');
                    return;
                }
                
                qrCodePreview.classList.remove('hidden');
                qrCodePreview.innerHTML = '';
                
                QRCode.toCanvas(this.value, { width: 120 }, function(error, canvas) {
                    if (error) {
                        console.error(error);
                        return;
                    }
                    qrCodePreview.appendChild(canvas);
                });
            });
            
            // 复制账号功能
            copyAccountBtn.addEventListener('click', function() {
                if (!accountNameInput.value.trim()) return;
                
                navigator.clipboard.writeText(accountNameInput.value.trim()).then(function() {
                    copySuccess.classList.add('show');
                    setTimeout(function() {
                        copySuccess.classList.remove('show');
                    }, 2000);
                });
            });
            
            // 自定义二维码上传处理
            customQrDropzone.addEventListener('click', () => customQrInput.click());
            
            customQrInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    alert('请上传图片文件');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    customQrImg = new Image();
                    customQrImg.src = e.target.result;
                    customQrImg.onload = function() {
                        customQrImage.src = e.target.result;
                        customQrPreview.classList.remove('hidden');
                    };
                };
                reader.readAsDataURL(file);
            });
            
            // 移除自定义二维码
            removeCustomQrBtn.addEventListener('click', function() {
                customQrImg = null;
                customQrPreview.classList.add('hidden');
                customQrInput.value = '';
            });
            
            // 生成拼接图片
            generateBtn.addEventListener('click', function() {
                if (uploadedImages.length === 0) {
                    alert('请先上传至少一张图片');
                    return;
                }
                
                const amount = document.getElementById('amountInput').value.trim();
                const accountName = document.getElementById('accountNameInput').value.trim();
                const qrContent = document.getElementById('qrContentInput').value.trim();
                const direction = document.querySelector('input[name="direction"]:checked').value;
                
                generateStitchedImage(amount, accountName, qrContent, direction);
            });
            
            function generateStitchedImage(amount, accountName, qrContent, direction) {
                const isVertical = direction === 'vertical';
                
                // 计算统一宽度（取所有图片中的最大宽度）
                const maxWidth = Math.max(...uploadedImages.map(img => img.width));
                
                // 计算总尺寸
                let totalWidth = 0;
                let totalHeight = 0;
                
                if (isVertical) {
                    totalWidth = maxWidth;
                    // 计算等宽后的总高度
                    totalHeight = uploadedImages.reduce((sum, img) => {
                        const ratio = maxWidth / img.width;
                        return sum + img.height * ratio;
                    }, 0);
                } else {
                    // 水平拼接时保持高度一致（取最大高度）
                    const maxHeight = Math.max(...uploadedImages.map(img => img.height));
                    totalHeight = maxHeight;
                    // 计算等高等宽后的总宽度
                    totalWidth = uploadedImages.reduce((sum, img) => {
                        const ratio = maxHeight / img.height;
                        return sum + img.width * ratio;
                    }, 0);
                }
                
                // 添加信息区域高度
                const infoHeight = 180;
                if (isVertical) {
                    totalHeight += infoHeight;
                    totalWidth = Math.max(totalWidth, 700); // 确保信息区域宽度足够
                } else {
                    totalWidth += 300; // 信息区域宽度
                    totalHeight = Math.max(totalHeight, infoHeight);
                }
                
                // 设置画布尺寸
                resultCanvas.width = totalWidth;
                resultCanvas.height = totalHeight;
                const ctx = resultCanvas.getContext('2d');
                
                // 填充背景
                switch(selectedBackground) {
                    case 'pattern2':
                        // 重新设计的蓝紫渐变背景
                        const gradient = ctx.createLinearGradient(0, 0, 0, totalHeight);
                        gradient.addColorStop(0, '#3b82f6'); // 更明亮的蓝色开始
                        gradient.addColorStop(1, '#7c3aed'); // 更柔和的紫色结束
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, totalWidth, totalHeight);
                        break;
                    case 'pattern3':
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, totalWidth, totalHeight);
                        
                        // 绘制几何图案背景
                        const patternSize = 20;
                        for (let y = 0; y < totalHeight; y += patternSize) {
                            for (let x = 0; x < totalWidth; x += patternSize) {
                                // 蓝色点
                                ctx.beginPath();
                                ctx.arc(x, y, 1, 0, Math.PI * 2);
                                ctx.fillStyle = '#4a6cf7';
                                ctx.fill();
                                
                                // 橙色点
                                ctx.beginPath();
                                ctx.arc(x + 10, y + 10, 1, 0, Math.PI * 2);
                                ctx.fillStyle = '#ff7b25';
                                ctx.fill();
                            }
                        }
                        break;
                    case 'pattern4':
                        // 绘制网格线背景
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, totalWidth, totalHeight);
                        
                        const gridSize = 20;
                        ctx.strokeStyle = '#e2e8f0';
                        ctx.lineWidth = 1;
                        
                        // 绘制垂直线
                        for (let x = 0; x <= totalWidth; x += gridSize) {
                            ctx.beginPath();
                            ctx.moveTo(x, 0);
                            ctx.lineTo(x, totalHeight);
                            ctx.stroke();
                        }
                        
                        // 绘制水平线
                        for (let y = 0; y <= totalHeight; y += gridSize) {
                            ctx.beginPath();
                            ctx.moveTo(0, y);
                            ctx.lineTo(totalWidth, y);
                            ctx.stroke();
                        }
                        break;
                    default:
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, totalWidth, totalHeight);
                }
                
                // 添加信息区域
                if (isVertical) {
                    // 垂直拼接 - 信息区域在顶部
                    let currentY = 0;
                    
                    // 添加结算信息
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'left';
                    
                    // 垂直居中布局
                    const centerY = infoHeight / 2;
                    
                    // 计算文字总高度
                    let textTotalHeight = 0;
                    if (amount) textTotalHeight += 42 + 10; // 金额高度 + 间距
                    if (accountName) textTotalHeight += 26 + 10; // 账号高度 + 间距
                    if (accountName) textTotalHeight += 16 + 10; // AI支持文字高度 + 间距
                    
                    // 计算起始Y坐标，使文字区域垂直居中
                    let textY = centerY - textTotalHeight / 2 + 30; // +30 是为了文字垂直居中的微调
                    
                    if (amount) {
                        // 使用鲜艳橙色显示金额
                        ctx.fillStyle = '#FF6B00';
                        ctx.font = 'bold 42px Arial';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                        ctx.shadowBlur = 3;
                        ctx.shadowOffsetX = 1;
                        ctx.shadowOffsetY = 1;
                        ctx.fillText(`总金额: ${amount}元`, 30, textY);
                        
                        textY += 60;
                    }
                    
                    if (accountName) {
                        ctx.font = 'bold 26px Arial';
                        ctx.fillStyle = selectedBackground === 'pattern2' ? 'white' : '#1e40af';
                        ctx.shadowBlur = selectedBackground === 'pattern2' ? 2 : 0;
                        ctx.shadowColor = selectedBackground === 'pattern2' ? 'rgba(0, 0, 0, 0.3)' : 'transparent';
                        ctx.fillText(`收款账号: ${accountName}`, 30, textY);
                        
                        textY += 40;
                        
                        // 添加含光AI支持文字
                        ctx.font = '16px Arial';
                        ctx.fillStyle = selectedBackground === 'pattern2' ? 'rgba(255, 255, 255, 0.9)' : '#64748b';
                        ctx.shadowBlur = 0;
                        ctx.fillText('由含光+AI提供设计支持', 30, textY);
                        
                        textY += 30;
                    }
                    
                    // 添加二维码（优先使用自定义二维码）
                    if (customQrImg || qrContent) {
                        const qrSize = 100;
                        const qrX = totalWidth - qrSize - 30;
                        // 统一高度，让二维码与文字区域垂直居中对齐
                        const qrY = centerY - qrSize / 2; // 与文字区域整体垂直居中对齐
                        
                        if (customQrImg) {
                            // 绘制自定义二维码
                            ctx.strokeStyle = selectedBackground === 'pattern2' ? 'white' : '#3b82f6';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(qrX-4, qrY-4, qrSize+8, qrSize+8);
                            ctx.drawImage(customQrImg, qrX, qrY, qrSize, qrSize);
                        } else if (qrContent) {
                            // 生成系统二维码
                            QRCode.toCanvas(qrContent, { width: qrSize }, function(error, canvas) {
                                if (error) return;
                                ctx.strokeStyle = selectedBackground === 'pattern2' ? 'white' : '#3b82f6';
                                ctx.lineWidth = 2;
                                ctx.strokeRect(qrX-4, qrY-4, qrSize+8, qrSize+8);
                                ctx.drawImage(canvas, qrX, qrY, qrSize, qrSize);
                            });
                        }
                        
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = selectedBackground === 'pattern2' ? 'white' : '#3b82f6';
                        ctx.fillText('扫码支付', qrX + qrSize/2 - 50, qrY + qrSize + 25);
                    }
                    
                    // 拼接图片（从信息区域下方开始）
                    currentY = infoHeight;
                    for (const img of uploadedImages) {
                        const ratio = maxWidth / img.width;
                        const scaledHeight = img.height * ratio;
                        ctx.drawImage(img, 0, currentY, maxWidth, scaledHeight);
                        currentY += scaledHeight;
                    }
                } else {
                    // 水平拼接 - 信息区域在左侧
                    let currentX = 0;
                    
                    // 添加结算信息
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'left';
                    
                    // 垂直居中布局
                    const centerY = infoHeight / 2;
                    
                    // 计算文字总高度
                    let textTotalHeight = 0;
                    if (amount) textTotalHeight += 36 + 10; // 金额高度 + 间距
                    if (accountName) textTotalHeight += 24 + 10; // 账号高度 + 间距
                    if (accountName) textTotalHeight += 14 + 10; // AI支持文字高度 + 间距
                    
                    // 计算起始Y坐标，使文字区域垂直居中
                    let textY = centerY - textTotalHeight / 2 + 25; // +25 是为了文字垂直居中的微调
                    
                    if (amount) {
                        // 使用鲜艳橙色显示金额
                        ctx.fillStyle = '#FF6B00';
                        ctx.font = 'bold 36px Arial';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                        ctx.shadowBlur = 3;
                        ctx.shadowOffsetX = 1;
                        ctx.shadowOffsetY = 1;
                        ctx.fillText(`总金额: ${amount}元`, 20, textY);
                        
                        textY += 50;
                    }
                    
                    if (accountName) {
                        ctx.font = 'bold 24px Arial';
                        ctx.fillStyle = selectedBackground === 'pattern2' ? 'white' : '#1e40af';
                        ctx.shadowBlur = selectedBackground === 'pattern2' ? 2 : 0;
                        ctx.shadowColor = selectedBackground === 'pattern2' ? 'rgba(0, 0, 0, 0.3)' : 'transparent';
                        ctx.fillText(`收款账号: ${accountName}`, 20, textY);
                        
                        textY += 40;
                        
                        // 添加含光AI支持文字
                        ctx.font = '14px Arial';
                        ctx.fillStyle = selectedBackground === 'pattern2' ? 'rgba(255, 255, 255, 0.9)' : '#64748b';
                        ctx.shadowBlur = 0;
                        ctx.fillText('由含光+AI提供设计支持', 20, textY);
                    }
                    
                    // 添加二维码（优先使用自定义二维码）
                    if (customQrImg || qrContent) {
                        const qrSize = 100;
                        const qrX = (300 - qrSize) / 2;
                        // 统一高度，让二维码与文字区域垂直居中对齐
                        const qrY = centerY - qrSize / 2; // 与文字区域整体垂直居中对齐
                        
                        if (customQrImg) {
                            // 绘制自定义二维码
                            ctx.strokeStyle = selectedBackground === 'pattern2' ? 'white' : '#3b82f6';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(qrX-4, qrY-4, qrSize+8, qrSize+8);
                            ctx.drawImage(customQrImg, qrX, qrY, qrSize, qrSize);
                        } else if (qrContent) {
                            // 生成系统二维码
                            QRCode.toCanvas(qrContent, { width: qrSize }, function(error, canvas) {
                                if (error) return;
                                ctx.strokeStyle = selectedBackground === 'pattern2' ? 'white' : '#3b82f6';
                                ctx.lineWidth = 2;
                                ctx.strokeRect(qrX-4, qrY-4, qrSize+8, qrSize+8);
                                ctx.drawImage(canvas, qrX, qrY, qrSize, qrSize);
                            });
                        }
                        
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = selectedBackground === 'pattern2' ? 'white' : '#3b82f6';
                        ctx.fillText('扫码支付', qrX + qrSize/2 - 50, qrY + qrSize + 25);
                    }
                    
                    // 拼接图片（从信息区域右侧开始）
                    currentX = 300;
                    const maxHeight = Math.max(...uploadedImages.map(img => img.height));
                    
                    for (const img of uploadedImages) {
                        const ratio = maxHeight / img.height;
                        const scaledWidth = img.width * ratio;
                        ctx.drawImage(img, currentX, 0, scaledWidth, maxHeight);
                        currentX += scaledWidth;
                    }
                }
                
                // 显示结果区域和下载头部
                resultContainer.classList.remove('hidden');
                downloadHeader.classList.remove('hidden');
                
                // 滚动到结果区域
                resultContainer.scrollIntoView({ behavior: 'smooth' });
            }
            
            // 下载图片
            downloadBtn.addEventListener('click', function() {
                if (!uploadedImages.length) return;
                
                const link = document.createElement('a');
                link.download = '账单拼接_' + new Date().toISOString().slice(0, 10) + '.png';
                link.href = resultCanvas.toDataURL('image/png');
                link.click();
            });
        });
    </script>
</body>
</html>
